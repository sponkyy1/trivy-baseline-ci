name: Trivy CI with manual baseline diff (jq)

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  trivy-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Build Docker image
        run: docker build -t myapp:ci-${{ github.run_id }} .

      - name: Run Trivy scan
        run: trivy image --format json -o trivy-results.json myapp:ci-${{ github.run_id }}

      - name: Check if baseline exists
        id: check_baseline
        run: |
          if [ -f .trivy/baseline.json ]; then
            echo "baseline_exists=true" >> $GITHUB_OUTPUT
          else
            echo "baseline_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Compare vulnerabilities with baseline (detailed diff)
        if: steps.check_baseline.outputs.baseline_exists == 'true'
        run: |
          jq -r '.Results[].Vulnerabilities[]? | [.VulnerabilityID, .PkgName, .InstalledVersion, .Severity, .Title] | @tsv' trivy-results.json | sort > current.tsv
          jq -r '.Results[].Vulnerabilities[]? | .VulnerabilityID' .trivy/baseline.json | sort -u > baseline_ids.txt

          echo "ğŸ›¡ï¸ New vulnerabilities (not in baseline):"
          echo ""

          while IFS=$'\t' read -r cve pkg ver sev title; do
            if ! grep -q "$cve" baseline_ids.txt; then
              echo "ğŸ†• $cve"
              echo "  Package: $pkg"
              echo "  Version: $ver"
              echo "  Severity: $sev"
              echo "  Title: $title"
              echo ""
            fi
          done < current.tsv

      - name: Update baseline in repo
        run: |
          mkdir -p .trivy
          cp trivy-results.json .trivy/baseline.json
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull origin main
          git add .trivy/baseline.json
          if git diff --cached --quiet; then
            echo "No baseline changes â€“ skipping commit."
          else
            git commit -m "Update Trivy baseline"
            git push origin main
          fi